<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…§éƒ¨ç¨½æ ¸ä½œæ¥­æµç¨‹åœ– & AI åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ html2pdf å¥—ä»¶ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- å¼•å…¥ marked.js ç”¨æ–¼è§£æ AI å›å‚³çš„ Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ 
            startOnLoad: true, 
            theme: 'base',
            themeVariables: {
                primaryColor: '#e0f2fe',
                edgeLabelBackground: '#ffffff',
                tertiaryColor: '#fff',
                lineColor: '#334155'
            },
            flowchart: {
                useMaxWidth: false,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f8fafc; }
        .mermaid { display: flex; justify-content: center; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        /* Loading Animation */
        .loading-dots:after {
            content: ' .';
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: ' .'; }
            40% { content: ' ..'; }
            60% { content: ' ...'; }
            80%, 100% { content: ''; }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="p-4 md:p-8 text-slate-800">

    <div class="max-w-7xl mx-auto space-y-8">
        
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-800 mb-2">å…§éƒ¨ç¨½æ ¸ç¼ºå¤±æ”¹å–„æš¨çµæ¡ˆä½œæ¥­ç³»çµ±</h1>
                <p class="text-slate-600">æ¨™æº–ä½œæ¥­æµç¨‹åœ– (SOP) èˆ‡ AI è¼”åŠ©å·¥å…·</p>
            </div>
            <div class="flex gap-3">
                <button onclick="downloadPNG()" class="bg-indigo-50 hover:bg-indigo-100 text-indigo-700 font-semibold py-2 px-4 rounded border border-indigo-200 transition-colors flex items-center text-sm">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    ä¸‹è¼‰æµç¨‹åœ– (PNG)
                </button>
                <button id="pdfBtn" onclick="downloadPDF()" class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded border border-slate-300 transition-colors flex items-center text-sm">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    ä¸‹è¼‰æµç¨‹åœ– (PDF)
                </button>
            </div>
        </div>

        <!-- Grid Layout: Flowchart (Left) & AI (Right) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Column: Flowchart (Span 2) -->
            <div class="lg:col-span-2 flex flex-col h-full">
                <div id="print-area" class="bg-white rounded-lg shadow-lg p-6 h-full">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-slate-700">ä½œæ¥­æµç¨‹åœ–</h2>
                        <div class="flex gap-4 text-xs">
                            <div class="flex items-center"><span class="w-3 h-3 bg-blue-100 border border-blue-500 mr-2 rounded-sm"></span>ç¨½æ ¸å®¤</div>
                            <div class="flex items-center"><span class="w-3 h-3 bg-green-100 border border-green-500 mr-2 rounded-sm"></span>å—æª¢å–®ä½</div>
                            <div class="flex items-center"><span class="w-3 h-3 bg-yellow-100 border border-yellow-600 mr-2 rounded-sm"></span>ç®¡ç†å±¤</div>
                        </div>
                    </div>

                    <!-- Mermaid Diagram Container -->
                    <div id="mermaid-container" class="mermaid overflow-x-auto">
                        graph TD
                            %% å®šç¾©æ¨£å¼
                            classDef audit fill:#e0f2fe,stroke:#0284c7,stroke-width:2px;
                            classDef unit fill:#dcfce7,stroke:#16a34a,stroke-width:2px;
                            classDef mgmt fill:#fef3c7,stroke:#d97706,stroke-width:2px;
                            classDef doc fill:#f3f4f6,stroke:#4b5563,stroke-dasharray: 5 5;
                            classDef startend fill:#1e293b,stroke:#000,color:#fff;

                            %% --- éšæ®µä¸€ï¼šç¼ºå¤±æåˆ— (æµç¨‹ä¸€) ---
                            Start((é–‹å§‹)):::startend --> Step1[ç¨½æ ¸äººå“¡<br/>æ–°å¢ç¼ºå¤±æ…‹æ¨£]:::audit
                            Step1 --> Doc1(æµç¨‹ä¸€<br/>ç¼ºå¤±å»ºç«‹):::doc
                            Doc1 --> Step2[ç”¢è£½:å…§éƒ¨ç¨½æ ¸æåˆ—æ„è¦‹<br/>æš¨è¾¦ç†æ”¹å–„æƒ…å½¢å½™ç¸½è¡¨]:::audit
                            Step2 --> Doc2(æµç¨‹äºŒè¡¨å–®<br/>å«é¢¨éšªç­‰ç´š/æ‘˜è¦/è™•ç†æ„è¦‹):::doc
                            
                            %% --- éšæ®µäºŒï¼šå—æŸ¥å–®ä½è¾¦ç† (æµç¨‹äºŒ) ---
                            Doc2 --> Step3[ç¨½æ ¸äººå“¡æª¢è¦–ç™¼é€]:::audit
                            Step3 -->|ç™¼é€| Step4[å—æª¢å–®ä½å‰¯ä¸»ç®¡<br/>*è‹¥ä¼‘å‡è‡ªå‹•ç™¼é€ä»£ç†äºº]:::unit
                            Step4 -->|åˆ†æ´¾ç¼ºå¤±| Step5[ç¶“è¾¦äººå“¡<br/>è¾¦ç†æ”¹å–„]:::unit
                            Step5 -->|å¡«å¯«èªªæ˜/æª¢é™„æª”æ¡ˆ| Step6[ç¶“è¾¦äººå“¡ç°½è¨»å®Œæˆ]:::unit
                            Step6 --> Step7{å–®ä½å…§éƒ¨è¦†æ ¸}:::unit
                            
                            Step7 -->|ä¸Šå‘ˆ| Step8[å‰¯ä¸»ç®¡è¦†æ ¸]:::unit
                            Step8 -->|ä¸Šå‘ˆ| Step9[ç¶“ç†æ ¸å‡†]:::unit
                            Step8 -.->|é€€å›| Step5
                            Step9 -.->|é€€å›| Step5

                            %% --- éšæ®µä¸‰ï¼šç¨½æ ¸å®¤è¦†æ ¸ (æµç¨‹äºŒ) ---
                            Step9 -->|å›å‚³| Step10[ç¨½æ ¸äººå“¡<br/>å¡«è¨»è¦†æ ¸çµæœ]:::audit
                            Step10 -->|ä¸Šå‘ˆ| Step11{ç¨½æ ¸è¦†æ ¸ä¸»ç®¡<br/>é¸æ“‡:æ—oræ›¾}:::audit
                            Step10 -.->|é€€å›è£œä»¶| Step5
                            
                            Step11 --> Step12[ç¸½ç¨½æ ¸]:::audit
                            Step11 -.->|é€€å›| Step10
                            Step12 -.->|é€€å›| Step10

                            %% --- éšæ®µå››ï¼šé«˜éšç°½æ ¸ (æµç¨‹äºŒ) ---
                            Step12 -->|è½‰æ•¬æœƒ| Step13{ç£å°å”ç†<br/>é¸æ“‡:æ›¾oré™³}:::mgmt
                            Step13 --> Step14[å‰¯ç¸½ç¶“ç†]:::mgmt
                            Step14 --> Step15[ç¸½ç¶“ç†]:::mgmt
                            
                            Step13 -.->|é€€å›| Step12
                            Step14 -.->|é€€å›| Step13
                            Step15 -.->|é€€å›| Step14

                            %% --- éšæ®µäº”ï¼šçµæ¡ˆèˆ‡è©•åˆ† (æµç¨‹ä¸‰) ---
                            Step15 -->|ç°½æ ¸å®Œæˆ| Step16[ç”¢è£½:ç¨½æ ¸ä½œæ¥­<br/>å—æŸ¥å–®ä½ç¼ºå¤±äº‹é …è¡¨]:::audit
                            Step16 --> Doc3(æµç¨‹ä¸‰è¡¨å–®<br/>å«åŠ æ¸›åˆ†/åŠ ç¸½åˆ†æ•¸):::doc
                            Doc3 --> Step17[ç¨½æ ¸äººå“¡ç¢ºèªåˆ†æ•¸]:::audit
                            
                            Step17 --> Step18{ç¨½æ ¸è¦†æ ¸ä¸»ç®¡<br/>é¸æ“‡:æ›¾oræ—}:::audit
                            Step18 --> Step19[ç¸½ç¨½æ ¸]:::audit
                            Step19 --> Step20{ç£å°å”ç†<br/>é¸æ“‡:æ›¾oré™³}:::mgmt
                            Step20 --> Step21[å‰¯ç¸½ç¶“ç†]:::mgmt
                            Step21 --> Step22[ç¸½ç¶“ç†]:::mgmt

                            %% æµç¨‹ä¸‰é€€å›æ©Ÿåˆ¶
                            Step18 -.->|é€€å›| Step17
                            Step19 -.->|é€€å›| Step18
                            Step20 -.->|é€€å›| Step19
                            Step21 -.->|é€€å›| Step20
                            Step22 -.->|é€€å›| Step21

                            %% --- éšæ®µå…­ï¼šçµæ¡ˆé€šçŸ¥ ---
                            Step22 -->|è½‰å›| Step23[ç¨½æ ¸äººå“¡<br/>çµæ¡ˆä½œæ¥­]:::audit
                            Step23 -->|å‚³é€ç°½æ ¸çµæœåŠç¸½æ‰£åˆ†| Step24[å—æª¢å–®ä½<br/>å‰¯ä¸»ç®¡åŠç¶“ç†]:::unit
                            Step24 --> End((çµæ¡ˆ)):::startend
                    </div>
                    
                    <div class="mt-8 border-t pt-4">
                        <h3 class="text-lg font-semibold text-slate-700">åœ–ä¾‹èªªæ˜</h3>
                        <ul class="list-disc list-inside text-slate-600 mt-2 grid grid-cols-1 md:grid-cols-2 gap-2">
                            <li><span class="font-bold text-blue-600">è—è‰²å€å¡Š</span>ï¼šç¨½æ ¸å®¤ä½œæ¥­ (Audit Dept)</li>
                            <li><span class="font-bold text-green-600">ç¶ è‰²å€å¡Š</span>ï¼šå—æª¢å–®ä½ä½œæ¥­ (Audited Unit)</li>
                            <li><span class="font-bold text-yellow-600">é»ƒè‰²å€å¡Š</span>ï¼šé«˜éšç®¡ç†å±¤ (Senior Mgmt)</li>
                            <li><span class="font-bold text-gray-500">è™›ç·šç®­é ­</span>ï¼šé€€å›/ä¿®æ­£è·¯å¾‘</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Right Column: Gemini AI Assistant -->
            <div class="lg:col-span-1">
                <div class="bg-gradient-to-b from-indigo-50 to-white rounded-lg shadow-lg border border-indigo-100 h-full flex flex-col sticky top-4">
                    <div class="p-4 border-b border-indigo-100 bg-indigo-600 rounded-t-lg">
                        <h2 class="text-xl font-bold text-white flex items-center">
                            <span class="text-2xl mr-2">âœ¨</span> HL2C AI ç¨½æ ¸æ™ºèƒ½åŠ©æ‰‹
                        </h2>
                        <p class="text-indigo-100 text-sm mt-1">HL2C</p>
                    </div>

                    <div class="p-6 flex-1 flex flex-col gap-6">
                        
                        <!-- 1. API Key Config Section (New) -->
                        <div class="bg-indigo-50 p-3 rounded-md border border-indigo-100 shadow-sm">
                            <label class="block text-xs font-bold text-indigo-700 mb-1 flex justify-between">
                                <span>ğŸ”‘ Google Gemini API Key è¨­å®š</span>
                                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-indigo-400 hover:text-indigo-600 underline">å–å¾— Key</a>
                            </label>
                            <input type="password" id="apiKeyInput" 
                                class="w-full p-2 border border-indigo-200 rounded text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none"
                                placeholder="è«‹åœ¨æ­¤è²¼ä¸Š API Key (sk-...)"
                                onchange="updateApiKey(this.value)">
                            <p class="text-[10px] text-indigo-500 mt-1 flex items-center">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                æ‚¨çš„é‡‘é‘°åƒ…æš«å­˜æ–¼è¨˜æ†¶é«”ï¼Œé—œé–‰ç¶²é å³æ¸…é™¤ã€‚
                            </p>
                        </div>

                        <!-- 2. Input Section -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">
                                åŸå§‹ç¨½æ ¸ç™¼ç¾ / è§€å¯Ÿé»
                            </label>
                            <textarea id="auditInput" rows="4" 
                                class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm"
                                placeholder="ä¾‹å¦‚ï¼šä»Šæ—¥æŸ¥æ ¸ç™¼ç¾é›¶ç”¨é‡‘ä¿ç®¡ç®±åœ¨åˆä¼‘æœŸé–“æ²’æœ‰ä¸Šé–ï¼Œä¸”ç¶“è¾¦äººå“¡ä¸åœ¨åº§ä½ä¸Šã€‚"></textarea>
                        </div>

                        <!-- 3. Action Buttons Grid -->
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="generateAuditFinding()" 
                                class="col-span-2 bg-white border-2 border-indigo-600 text-indigo-700 hover:bg-indigo-50 font-bold py-2 px-4 rounded-lg flex items-center justify-center transition-colors">
                                <span>ğŸ“ ç”Ÿæˆç¼ºå¤±å ±å‘Š</span>
                            </button>
                            <button onclick="assessRisk()" 
                                class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-2 rounded-lg flex items-center justify-center transition-colors shadow-md text-sm">
                                <span>ğŸ›¡ï¸ é¢¨éšªè©•ä¼°</span>
                            </button>
                            <button onclick="analyzeRootCause()" 
                                class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-2 rounded-lg flex items-center justify-center transition-colors shadow-md text-sm">
                                <span>ğŸ” æ ¹å› åˆ†æ</span>
                            </button>
                            <button onclick="generateInterviewQuestions()" 
                                class="col-span-2 bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center transition-colors shadow-md">
                                <span>â“ ç”Ÿæˆå»¶ä¼¸è¨ªè«‡æå•</span>
                            </button>
                        </div>

                        <!-- 4. Result Section -->
                        <div class="flex-1 min-h-[300px] border rounded-lg bg-slate-50 relative overflow-hidden flex flex-col">
                            <div class="bg-slate-200 px-3 py-1 text-xs font-bold text-slate-600 uppercase tracking-wider">
                                AI åˆ†æçµæœ
                            </div>
                            <div id="resultContent" class="p-4 text-sm text-slate-700 overflow-y-auto flex-1 prose prose-sm max-w-none">
                                <p class="text-slate-400 italic text-center mt-8">è«‹å…ˆè¼¸å…¥ API Key<br>æ¥è‘—è¼¸å…¥å…§å®¹ä¸¦é»æ“ŠåŠŸèƒ½æŒ‰éˆ•...</p>
                            </div>
                            <!-- Loading Overlay -->
                            <div id="loadingOverlay" class="absolute inset-0 bg-white/90 hidden flex flex-col items-center justify-center z-10">
                                <div class="w-8 h-8 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mb-2"></div>
                                <span class="text-indigo-600 font-medium loading-dots">æ­£åœ¨æ€è€ƒä¸­</span>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for Functionalities -->
    <script>
        // --- 1. PDF & PNG Download Logic ---
        function downloadPDF() {
            const element = document.getElementById('print-area');
            const btn = document.getElementById('pdfBtn');
            const originalText = btn.innerHTML;
            
            btn.innerText = "ç”¢è£½ä¸­...";
            btn.disabled = true;

            const opt = {
                margin:       5,
                filename:     'ç¨½æ ¸ä½œæ¥­æµç¨‹åœ–.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, logging: false },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'landscape' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }).catch(err => {
                console.error(err);
                alert("ç”¢è£½å¤±æ•—ï¼Œå»ºè­°ä½¿ç”¨ã€Œä¸‹è¼‰ PNGã€åŠŸèƒ½ã€‚");
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        async function downloadPNG() {
            const svgElement = document.querySelector("#mermaid-container svg");
            if (!svgElement) {
                alert("æµç¨‹åœ–å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å€™");
                return;
            }

            const serializer = new XMLSerializer();
            const svgString = serializer.serializeToString(svgElement);
            const svgBlob = new Blob([svgString], {type: "image/svg+xml;charset=utf-8"});
            const url = URL.createObjectURL(svgBlob);

            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement("canvas");
                const scale = 2; 
                canvas.width = svgElement.getBoundingClientRect().width * scale;
                canvas.height = svgElement.getBoundingClientRect().height * scale;
                
                const ctx = canvas.getContext("2d");
                ctx.fillStyle = "white";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.scale(scale, scale);
                ctx.drawImage(img, 0, 0);

                const pngUrl = canvas.toDataURL("image/png");
                const downloadLink = document.createElement("a");
                downloadLink.href = pngUrl;
                downloadLink.download = "ç¨½æ ¸ä½œæ¥­æµç¨‹åœ–.png";
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                
                URL.revokeObjectURL(url);
            };
            img.src = url;
        }

        // --- 2. Gemini AI Integration Logic ---
        
        let userApiKey = ""; // Stores the key in memory only

        function updateApiKey(val) {
            userApiKey = val.trim();
        }

        const systemPrompt = `ä½ æ˜¯ä¸€ä½è³‡æ·±çš„å…§éƒ¨ç¨½æ ¸å°ˆå®¶ï¼Œç†Ÿæ‚‰ä¼æ¥­å…§éƒ¨æ§åˆ¶åˆ¶åº¦ã€é¢¨éšªè©•ä¼°èˆ‡å¯©è¨ˆæº–å‰‡ã€‚
        ä½ çš„ä»»å‹™æ˜¯å”åŠ©ç¨½æ ¸äººå“¡å°‡ç²—ç•¥çš„è§€å¯Ÿé»è½‰åŒ–ç‚ºå°ˆæ¥­çš„å·¥ä½œåº•ç¨¿ã€‚
        è«‹éµå¾ªä»¥ä¸‹åŸå‰‡ï¼š
        1. èªæ°£å°ˆæ¥­ã€å®¢è§€ã€ç°¡æ½”ã€‚
        2. å¼•ç”¨ç›¸é—œå…§æ§ç²¾ç¥ï¼ˆä¾‹å¦‚ï¼šè³‡ç”¢ä¿å…¨ã€è·è²¬åˆ†å·¥ï¼‰ã€‚
        3. è¼¸å‡ºæ ¼å¼å¿…é ˆæ¸…æ™°æ˜“è®€ï¼ˆä½¿ç”¨Markdownï¼‰ã€‚`;

        async function callGemini(userPrompt) {
            // Check for API Key
            if (!userApiKey) {
                alert("è«‹å…ˆåœ¨å³å´é¢æ¿ä¸Šæ–¹è¼¸å…¥æ‚¨çš„ Google Gemini API Key æ‰èƒ½ä½¿ç”¨ AI åŠŸèƒ½ã€‚");
                document.getElementById('apiKeyInput').focus();
                return;
            }

            const resultDiv = document.getElementById('resultContent');
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            loadingOverlay.classList.remove('hidden');
            loadingOverlay.classList.add('flex');
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userPrompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || response.statusText);
                }

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    resultDiv.innerHTML = marked.parse(text);
                } else {
                    resultDiv.innerHTML = '<p class="text-red-500">ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¢ºèªè¼¸å…¥å…§å®¹æ˜¯å¦æ­£ç¢ºã€‚</p>';
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                resultDiv.innerHTML = `<p class="text-red-500 font-bold">ç™¼ç”ŸéŒ¯èª¤</p><p class="text-red-500 text-xs">${error.message}<br><br>è«‹æª¢æŸ¥æ‚¨çš„ API Key æ˜¯å¦æ­£ç¢ºã€‚</p>`;
            } finally {
                loadingOverlay.classList.add('hidden');
                loadingOverlay.classList.remove('flex');
            }
        }

        function generateAuditFinding() {
            const input = document.getElementById('auditInput').value.trim();
            if (!input) { alert("è«‹å…ˆè¼¸å…¥åŸå§‹ç¨½æ ¸ç™¼ç¾å…§å®¹"); return; }
            const prompt = `è«‹å°‡ä»¥ä¸‹ç¨½æ ¸è§€å¯Ÿé»æ”¹å¯«ç‚ºæ­£å¼çš„å…§éƒ¨ç¨½æ ¸å ±å‘Šæ ¼å¼ã€‚
            è¼¸å…¥å…§å®¹ï¼š${input}
            è«‹ä¾åºç”¢å‡ºï¼š
            1. **ç¼ºå¤±æ‘˜è¦** (Summary)ï¼šç°¡æ˜æ‰¼è¦åœ°æè¿°äº‹å¯¦ï¼Œé©åˆå¡«å…¥å ±è¡¨ã€‚
            2. **è©³ç´°èªªæ˜** (Description)ï¼šè©³ç´°æè¿°äººã€äº‹ã€æ™‚ã€åœ°ã€ç‰©åŠé•åä¹‹åŸå‰‡ã€‚
            3. **è™•ç†æ„è¦‹** (Audit Recommendation)ï¼šå…·é«”çš„æ”¹å–„å»ºè­°æªæ–½ã€‚`;
            callGemini(prompt);
        }

        function assessRisk() {
            const input = document.getElementById('auditInput').value.trim();
            if (!input) { alert("è«‹å…ˆè¼¸å…¥åŸå§‹ç¨½æ ¸ç™¼ç¾å…§å®¹"); return; }
            const prompt = `è«‹é‡å°ä»¥ä¸‹ç¨½æ ¸ç¼ºå¤±é€²è¡Œé¢¨éšªè©•ä¼°ã€‚
            ç¼ºå¤±å…§å®¹ï¼š${input}
            è«‹åˆ†æä¸¦ç”¢å‡ºï¼š
            1. **é¢¨éšªç­‰ç´š** (Risk Level)ï¼šè«‹åˆ¤å®šç‚º é«˜ / ä¸­ / ä½ï¼Œä¸¦èªªæ˜åˆ¤æ–·ç†ç”±ã€‚
            2. **æ½›åœ¨å½±éŸ¿** (Impact)ï¼šè‹¥ä¸æ”¹å–„å¯èƒ½å°è‡´çš„å¾Œæœã€‚
            3. **å»ºè­°æ‰£åˆ†å¹…åº¦** (Suggested Deduction)ï¼šä¾æ“šä¸€èˆ¬ç¨½æ ¸å¯¦å‹™ï¼Œå»ºè­°æ‰£åˆ†ç¯„åœã€‚
            è«‹ç”¨è¡¨æ ¼æˆ–åˆ—é»æ–¹å¼å‘ˆç¾ã€‚`;
            callGemini(prompt);
        }

        function analyzeRootCause() {
            const input = document.getElementById('auditInput').value.trim();
            if (!input) { alert("è«‹å…ˆè¼¸å…¥åŸå§‹ç¨½æ ¸ç™¼ç¾å…§å®¹"); return; }
            const prompt = `è«‹é‡å°ä»¥ä¸‹ç¨½æ ¸ç¼ºå¤±é€²è¡Œæ·±åº¦æ ¹å› åˆ†æèˆ‡é é˜²å»ºè­°ã€‚
            ç¼ºå¤±å…§å®¹ï¼š${input}
            è«‹åˆ†æä¸¦ç”¢å‡ºï¼š
            1. **å¯èƒ½æ ¹å›  (Root Cause)**ï¼šè«‹å¾ã€Œäººå“¡ (People)ã€ã€ã€Œæµç¨‹ (Process)ã€ã€ã€Œç³»çµ± (System)ã€ä¸‰å€‹é¢å‘åˆ†æå¯èƒ½åŸå› ã€‚
            2. **é•åä¹‹å…§æ§åŸå‰‡**ï¼šæŒ‡å‡ºæ­¤ç¼ºå¤±é•åäº†ä»€éº¼å…§æ§ç²¾ç¥ï¼ˆå¦‚ï¼šè·è²¬åˆ†å·¥ã€è¦†æ ¸æ©Ÿåˆ¶ï¼‰ã€‚
            3. **é é˜²æ€§æ§åˆ¶å»ºè­°**ï¼šå¦‚ä½•å¾æºé ­é˜²æ­¢å†æ¬¡ç™¼ç”Ÿï¼ˆä¸åƒ…åƒ…æ˜¯ä¿®æ­£ç•¶ä¸‹éŒ¯èª¤ï¼‰ã€‚`;
            callGemini(prompt);
        }

        function generateInterviewQuestions() {
            const input = document.getElementById('auditInput').value.trim();
            if (!input) { alert("è«‹å…ˆè¼¸å…¥åŸå§‹ç¨½æ ¸ç™¼ç¾å…§å®¹"); return; }
            const prompt = `æˆ‘æ˜¯ç¨½æ ¸äººå“¡ï¼Œè§€å¯Ÿåˆ°äº†ä»¥ä¸‹ç¼ºå¤±ï¼š${input}ã€‚
            ç‚ºäº†é€²ä¸€æ­¥é‡æ¸…äº‹å¯¦ã€ç¢ºèªå½±éŸ¿ç¯„åœæˆ–äº†è§£æµç¨‹æ–·é»ï¼Œè«‹å¹«æˆ‘ç”Ÿæˆ 3-5 å€‹ã€Œå»¶ä¼¸è¨ªè«‡å•é¡Œã€ã€‚
            
            é€™äº›å•é¡Œæ‡‰è©²ï¼š
            1. é‡å°å—æŸ¥å–®ä½çš„ç¶“è¾¦äººå“¡æˆ–ä¸»ç®¡ã€‚
            2. èªæ°£å°ˆæ¥­ä½†å…·å‚™æ¢è©¢æ€§ã€‚
            3. ç›®çš„æ˜¯æŒ–æ˜å‡ºçœŸæ­£çš„å•é¡Œæ ¹æºã€‚`;
            callGemini(prompt);
        }
    </script>
</body>
</html>