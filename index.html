<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>花蓮二信智慧稽核小幫手 | Intelligent Audit Workbench</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 marked.js 用於解析 AI 回傳的 Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Google Fonts for professional typography -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif; 
            background-color: #f1f5f9; /* Slate-100 */
            color: #1e293b; /* Slate-800 */
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Prose styles override */
        .prose h3 { margin-top: 1.5em; margin-bottom: 0.5em; color: #334155; font-weight: 700; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; }
        .prose strong { color: #0f172a; }

        /* --- Enhanced Table Styles --- */
        .prose table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid #64748b; /* Slate-500: 明顯的外框 */
            margin-top: 1.5em;
            margin-bottom: 1.5em;
            background-color: white;
        }
        .prose th {
            background-color: #e2e8f0; /* Slate-200: 標題列底色 */
            border: 1px solid #64748b; /* 明顯的分隔線 */
            padding: 0.75rem;
            font-weight: 700;
            color: #0f172a;
            text-align: left;
        }
        .prose td {
            border: 1px solid #64748b; /* 明顯的分隔線 */
            padding: 0.75rem;
            color: #334155;
            vertical-align: top;
        }
        .prose tr:nth-child(even) {
            background-color: #f8fafc; /* 偶數列微淡底色，增加閱讀性 */
        }
        
        /* Animation */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .loading-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4 sm:px-6 lg:px-8">

    <!-- Application Container -->
    <div class="w-full max-w-4xl space-y-6">
        
        <!-- Header Section -->
        <header class="text-center space-y-2">
            <div class="inline-flex items-center justify-center p-3 bg-indigo-600 rounded-xl shadow-lg mb-2">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-slate-900 tracking-tight">花蓮二信智慧稽核小幫手</h1>
            <p class="text-slate-500 font-medium">HL2C Intelligent Audit </p>
        </header>

        <!-- Main Workspace -->
        <main class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
            
            <!-- Top Bar: Context & Persona -->
            <div class="bg-slate-50 border-b border-slate-200 px-6 py-4 flex items-center justify-between">
                <div class="flex items-center space-x-2 text-sm text-slate-600">
                    <span class="inline-block w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                    <span>系統狀態：線上 (Gemini 2.5 Ready)</span>
                </div>
                <div class="text-xs font-mono text-slate-400">v2.7.0 (Architecture-Ready)</div>
            </div>

            <div class="p-6 lg:p-8 space-y-8">
                
                <!-- API Key Section -->
                <div class="bg-indigo-50 border border-indigo-100 rounded-lg p-4 shadow-sm">
                    <label for="apiKeyInput" class="block text-sm font-bold text-indigo-900 mb-2 flex justify-between items-center">
                        <span class="flex items-center">
                            <svg class="w-4 h-4 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path></svg>
                            Google Gemini API Key 設定
                        </span>
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-indigo-600 hover:text-indigo-800 underline bg-white px-2 py-1 rounded border border-indigo-200 hover:bg-indigo-50 transition-colors">取得 API Key</a>
                    </label>
                    <div class="relative">
                        <input type="password" id="apiKeyInput" 
                            class="block w-full rounded-md border-indigo-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2.5 text-slate-700 bg-white" 
                            placeholder="請在此貼上您的 API Key (sk-...)"
                            onchange="updateApiKey(this.value)">
                    </div>
                    <p class="mt-2 text-xs text-indigo-500 flex items-center">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        您的金鑰僅暫存於記憶體，關閉網頁即清除。
                    </p>
                </div>

                <!-- Input Area -->
                <div class="space-y-3">
                    <label for="auditInput" class="block text-sm font-semibold text-slate-700">
                        查核發現與觀察 (Audit Findings & Observations)
                    </label>
                    <div class="relative">
                        <textarea id="auditInput" rows="5" 
                            class="block w-full rounded-lg border-slate-300 bg-slate-50 p-4 text-slate-900 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm transition ease-in-out duration-150 resize-y border"
                            placeholder="請輸入原始的查核觀察點...
範例：查核發現營業廳監視影像保存時間僅有 25 天，未達二個月之規定，且無專人負責管理備份紀錄。"></textarea>
                        <div class="absolute bottom-3 right-3 text-xs text-slate-400">支援純文字輸入</div>
                    </div>
                </div>

                <!-- Functional Control Grid -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <button onclick="executeAI('report')" class="group relative flex items-center justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 shadow-md transition-all duration-200 transform hover:-translate-y-0.5">
                        <svg class="mr-2 h-5 w-5 text-indigo-200 group-hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        生成正式報告
                    </button>

                    <button onclick="executeAI('risk')" class="group relative flex items-center justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-slate-600 hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 shadow-md transition-all duration-200 transform hover:-translate-y-0.5">
                        <svg class="mr-2 h-5 w-5 text-slate-300 group-hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        風險評估分析
                    </button>

                    <button onclick="executeAI('rootcause')" class="group relative flex items-center justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 shadow-md transition-all duration-200 transform hover:-translate-y-0.5">
                        <svg class="mr-2 h-5 w-5 text-emerald-200 group-hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        根因分析
                    </button>

                    <button onclick="executeAI('interview')" class="group relative flex items-center justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-amber-500 hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 shadow-md transition-all duration-200 transform hover:-translate-y-0.5">
                        <svg class="mr-2 h-5 w-5 text-amber-100 group-hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                        訪談提問生成
                    </button>
                </div>

                <!-- Output Area -->
                <div class="relative min-h-[400px] rounded-xl bg-slate-50 border border-slate-200 p-6">
                    <!-- Label with ID for dynamic updates -->
                    <div id="resultLabel" class="absolute top-0 left-0 bg-slate-200 text-slate-600 px-3 py-1 text-xs font-bold uppercase tracking-wider rounded-br-lg border-b border-r border-slate-300">
                        AI Analysis Result
                    </div>

                    <!-- Content -->
                    <div id="resultContent" class="mt-4 prose prose-slate max-w-none text-sm text-slate-700 leading-relaxed">
                        <div class="flex flex-col items-center justify-center h-64 text-slate-400">
                            <svg class="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                            </svg>
                            <p class="text-center font-medium">請在上方輸入內容並選擇一項分析功能</p>
                            <p class="text-xs mt-2">系統將自動調用 Google Gemini 2.5 Flash 模型進行運算</p>
                        </div>
                    </div>

                    <!-- Loading Overlay (Hidden by default) -->
                    <div id="loadingOverlay" class="absolute inset-0 bg-white/90 backdrop-blur-sm hidden flex-col items-center justify-center z-10 rounded-xl transition-all duration-300">
                        <div class="relative w-16 h-16">
                            <div class="absolute inset-0 border-4 border-slate-200 rounded-full"></div>
                            <div class="absolute inset-0 border-4 border-indigo-600 rounded-full border-t-transparent animate-spin"></div>
                        </div>
                        <div class="mt-4 text-indigo-900 font-semibold tracking-wide loading-pulse">AI 正在深度分析中...</div>
                        <div id="loadingText" class="mt-1 text-xs text-indigo-500">正在解析法規與內控邏輯</div>
                    </div>
                </div>

                <!-- Footer / Copy Action -->
                <div class="flex justify-end pt-2 border-t border-slate-100">
                    <button onclick="copyResult()" class="text-xs text-slate-500 hover:text-indigo-600 flex items-center transition-colors">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                        複製分析結果
                    </button>
                </div>

            </div>
        </main>

        <footer class="text-center text-xs text-slate-400 mt-8">
            <p>&copy; 2025 Internal Audit Dept. All rights reserved. | Powered by Gemini 2.5</p>
        </footer>
    </div>

    <script>
        // System Configuration
        let userApiKey = ""; // Stores the key in memory only

        // --- MODEL VERSION CONFIGURATION ---
        // 目前環境支援的最新穩定版：gemini-2.5-flash-preview-09-2025
        // 待 Google 開放 Gemini 3.0 後，只需修改下方變數為對應的模型 ID (例如 'gemini-3.0-pro') 即可升級。
        const MODEL_ID = "gemini-2.5-flash-preview-09-2025"; 

        function updateApiKey(val) {
            userApiKey = val.trim();
        }

        // Core System Persona Definition
        const systemPrompt = `你是一位台灣金融業資深的內部稽核專家，熟悉金管會、中央銀行、銀行局、銀行公會等主管機關之法令規章（如銀行法、信用合作社法、洗錢防制法、資通安全管理法、金融機構安全維護管理辦法等）。
        你的任務是協助信用合作社（如花蓮二信）稽核人員將粗略的觀察點轉化為專業的工作底稿。

        請遵循以下原則：
        1. 語氣專業、客觀、簡潔。
        2. **法令依據**：請務必優先引用金管會、中央銀行等主管機關之最新法令、函釋或銀行公會規範作為查核依據，避免僅引用一般內控原則。
        3. **明確指出**：分析時必須明確列出「可能違反的法令名稱」及「具體條文/項次」。
        4. 輸出格式必須清晰易讀（使用Markdown）。`;

        // UI Helpers
        const dom = {
            input: document.getElementById('auditInput'),
            result: document.getElementById('resultContent'),
            overlay: document.getElementById('loadingOverlay'),
            loadingText: document.getElementById('loadingText'),
            label: document.getElementById('resultLabel')
        };

        // Function Name Mapping
        const functionNames = {
            'report': '生成正式報告',
            'risk': '風險評估分析',
            'rootcause': '根因分析',
            'interview': '訪談提問生成'
        };

        // Main Execution Handler
        async function executeAI(mode) {
            // 1. Check for API Key first
            if (!userApiKey) {
                alert("請先在上方藍色區塊輸入您的 Google Gemini API Key 才能使用 AI 功能。");
                document.getElementById('apiKeyInput').focus();
                return;
            }

            // 2. Check Input
            const inputVal = dom.input.value.trim();
            if (!inputVal) {
                showEmptyState("請先輸入稽核發現內容，系統才能進行分析。");
                return;
            }

            // Update Label to show which function is running
            if (functionNames[mode]) {
                dom.label.innerText = `AI Analysis Result : ${functionNames[mode]}`;
            }

            // Set loading state
            setLoading(true, mode);

            // Construct specific prompt based on mode
            let userPrompt = "";
            switch (mode) {
                case 'report':
                    userPrompt = `請將以下稽核觀察點改寫為正式的內部稽核報告格式。
                    輸入內容：${inputVal}
                    請依序產出：
                    1. **缺失摘要** (Summary)：簡明扼要地描述事實，適合填入報表。
                    2. **詳細說明** (Description)：詳細描述人、事、時、地、物及違反之法令條文（請明確指出金管會/央行/信用合作社相關法規名稱與條號）。
                    3. **處理意見** (Audit Recommendation)：具體的改善建議措施。`;
                    break;
                case 'risk':
                    userPrompt = `請針對以下稽核缺失進行風險評估。
                    缺失內容：${inputVal}
                    請分析並產出：
                    1. **風險等級** (Risk Level)：請判定為 高 / 中 / 低，並說明判斷理由。
                    2. **潛在影響** (Impact)：若不改善可能導致的後果（請考量財務、營運、法遵風險，並引用可能違反之法規）。
                    3. **建議扣分幅度** (Suggested Deduction)：依據一般稽核實務，建議扣分範圍。
                    請用表格呈現。`;
                    break;
                case 'rootcause':
                    userPrompt = `請針對以下稽核缺失進行深度根因分析與預防建議。
                    缺失內容：${inputVal}
                    請分析並產出：
                    1. **可能根因 (Root Cause)**：請從「人員 (People)」、「流程 (Process)」、「系統 (System)」三個面向分析可能原因。
                    2. **違反之內控原則與法規**：指出違反的內控精神及具體法令依據（如信用合作社法、金融控股公司及銀行業內部控制及稽核制度實施辦法等）。
                    3. **預防性控制建議**：如何從源頭防止再次發生（Systemic Fix）。`;
                    break;
                case 'interview':
                    userPrompt = `我是信用合作社稽核人員，觀察到了以下缺失：${inputVal}。
                    為了進一步釐清事實、確認影響範圍或了解流程斷點，請幫我生成 3-5 個「延伸訪談問題」。
                    
                    這些問題應該：
                    1. 針對受查單位的經辦人員或主管。
                    2. 語氣專業但具備探詢性。
                    3. 目的是挖掘出真正的問題根源與法規遵循狀況。`;
                    break;
            }

            try {
                // Call Gemini API with userApiKey AND Configured Model ID
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_ID}:generateContent?key=${userApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userPrompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `API Error (${response.status})`);
                }

                const data = await response.json();
                const markdownText = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (markdownText) {
                    renderResult(markdownText);
                } else {
                    renderError("AI 未回傳任何內容，請稍後再試。");
                }

            } catch (error) {
                console.error(error);
                renderError(`系統錯誤：${error.message}<br>請確認 API Key 是否正確或網路連線是否正常。<br>目前使用模型: ${MODEL_ID}`);
            } finally {
                setLoading(false);
            }
        }

        // --- Helper Functions ---

        function setLoading(isLoading, mode = '') {
            if (isLoading) {
                dom.overlay.classList.remove('hidden');
                dom.overlay.classList.add('flex');
                
                // Dynamic loading text
                const texts = {
                    'report': '正在撰寫正式報告...',
                    'risk': '正在評估潛在風險...',
                    'rootcause': '正在分析根本原因...',
                    'interview': '正在設計訪談策略...'
                };
                if (mode && texts[mode]) {
                    dom.loadingText.innerText = texts[mode];
                }
            } else {
                dom.overlay.classList.add('hidden');
                dom.overlay.classList.remove('flex');
            }
        }

        function renderResult(markdown) {
            dom.result.innerHTML = marked.parse(markdown);
            dom.result.classList.add('fade-in');
            // Re-apply animation class for next time
            setTimeout(() => dom.result.classList.remove('fade-in'), 500);
        }

        function renderError(msg) {
            dom.result.innerHTML = `<div class="text-red-500 font-medium p-4 border border-red-200 bg-red-50 rounded-lg text-center">${msg}</div>`;
        }
        
        function showEmptyState(msg) {
             dom.result.innerHTML = `<div class="text-amber-600 font-medium p-4 border border-amber-200 bg-amber-50 rounded-lg text-center">${msg}</div>`;
        }

        // Fixed Copy Function using execCommand for better compatibility
        function copyResult() {
            const text = dom.result.innerText;
            if(!text || text.includes("請在上方輸入")) return;
            
            // Fallback for iframe/restricted environments
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            // Ensure textarea is not visible but part of DOM
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                const msg = successful ? '內容已複製到剪貼簿' : '複製失敗';
                alert(msg);
            } catch (err) {
                console.error('複製失敗', err);
                alert('無法複製，請手動選取文字複製。');
            }
            
            document.body.removeChild(textArea);
        }
    </script>
</body>
</html>